#include <stdio.h>

#include "packer.h"

#define PARASITE_ENTRY (123)

#define PARA_LEN ((PARASITE_ENTRY) + 8)
#define TEXT_OFF ((PARASITE_ENTRY) + 20)
#define TEXT_LEN ((PARASITE_ENTRY) + 25)
#define JUMP_OLD ((PARASITE_ENTRY) + 77)

// XOR DL ////////////////////////////////////////
/* #define PARA_LEN (89) */
/* #define TEXT_OFF (101) */
/* #define TEXT_LEN (106) */
/* #define JUMP_OLD (158) */

/* uint8_t parasite[162] = { */
/* 	0x50, 0x57, 0x56, 0x52, 0x51, 0xeb, 0x4a, 0xc8, 0x00, 0x00, */
/* 	0x00, 0xb8, 0x05, 0x15, 0x00, 0x00, 0x48, 0x85, 0xf6, 0x74, */
/* 	0x1f, 0x48, 0x31, 0xc9, 0x48, 0x89, 0xc2, 0x48, 0xc1, 0xe0, */
/* 	0x05, 0x48, 0x01, 0xd0, 0x48, 0x0f, 0xb6, 0x17, 0x48, 0x01, */
/* 	0xd0, 0x48, 0xff, 0xc1, 0x48, 0xff, 0xc7, 0x48, 0x39, 0xf1, */
/* 	0x7c, 0xe4, 0xc9, 0xc3, 0xc8, 0x00, 0x00, 0x00, 0x48, 0x85, */
/* 	0xf6, 0x74, 0x10, 0x48, 0x31, 0xc9, 0x30, 0x17, 0x48, 0xff, */
/* 	0xc1, 0x48, 0xff, 0xc7, 0x48, 0x39, 0xf1, 0x7c, 0xf3, 0xc9, */
/* 	0xc3, 0x48, 0x8d, 0x3d, 0xf9, 0xff, 0xff, 0xff, 0xbe, 0x42, */
/* 	0x42, 0x42, 0x42, 0xe8, 0xa5, 0xff, 0xff, 0xff, 0x48, 0x8d, */
/* 	0x3d, 0xe8, 0xff, 0xff, 0xff, 0xbe, 0x42, 0x42, 0x42, 0x42, */
/* 	0xe8, 0xc3, 0xff, 0xff, 0xff, 0xe8, 0x0e, 0x00, 0x00, 0x00, */
/* 	0x2e, 0x2e, 0x2e, 0x2e, 0x57, 0x4f, 0x4f, 0x44, 0x59, 0x2e, */
/* 	0x2e, 0x2e, 0x2e, 0x0a, 0xb8, 0x01, 0x00, 0x00, 0x00, 0xbf, */
/* 	0x01, 0x00, 0x00, 0x00, 0x5e, 0xba, 0x0e, 0x00, 0x00, 0x00, */
/* 	0x0f, 0x05, 0x59, 0x5a, 0x5e, 0x5f, 0x58, 0xe9, 0x42, 0x42, */
/* 	0x42, 0x42 */
/* }; */

// XOR 42 ////////////////////////////////////////
/* #define PARA_LEN (90) */
/* #define TEXT_OFF (102) */
/* #define TEXT_LEN (107) */
/* #define JUMP_OLD (159) */

/* uint8_t parasite[163] = { */
/* 	0x50, 0x57, 0x56, 0x52, 0x51, 0xeb, 0x4b, 0xc8, 0x00, 0x00, */
/* 	0x00, 0xb8, 0x05, 0x15, 0x00, 0x00, 0x48, 0x85, 0xf6, 0x74, */
/* 	0x1f, 0x48, 0x31, 0xc9, 0x48, 0x89, 0xc2, 0x48, 0xc1, 0xe0, */
/* 	0x05, 0x48, 0x01, 0xd0, 0x48, 0x0f, 0xb6, 0x17, 0x48, 0x01, */
/* 	0xd0, 0x48, 0xff, 0xc1, 0x48, 0xff, 0xc7, 0x48, 0x39, 0xf1, */
/* 	0x7c, 0xe4, 0xc9, 0xc3, 0xc8, 0x00, 0x00, 0x00, 0x48, 0x85, */
/* 	0xf6, 0x74, 0x11, 0x48, 0x31, 0xc9, 0x80, 0x37, 0x42, 0x48, */
/* 	0xff, 0xc1, 0x48, 0xff, 0xc7, 0x48, 0x39, 0xf1, 0x7c, 0xf2, */
/* 	0xc9, 0xc3, 0x48, 0x8d, 0x3d, 0xa7, 0xff, 0xff, 0xff, 0xbe, */
/* 	0x42, 0x42, 0x42, 0x42, 0xe8, 0xa4, 0xff, 0xff, 0xff, 0x48, */
/* 	0x8d, 0x3d, 0xe8, 0xff, 0xff, 0xff, 0xbe, 0x42, 0x42, 0x42, */
/* 	0x42, 0xe8, 0xc2, 0xff, 0xff, 0xff, 0xe8, 0x0e, 0x00, 0x00, */
/* 	0x00, 0x2e, 0x2e, 0x2e, 0x2e, 0x57, 0x4f, 0x4f, 0x44, 0x59, */
/* 	0x2e, 0x2e, 0x2e, 0x2e, 0x0a, 0xb8, 0x01, 0x00, 0x00, 0x00, */
/* 	0xbf, 0x01, 0x00, 0x00, 0x00, 0x5e, 0xba, 0x0e, 0x00, 0x00, */
/* 	0x00, 0x0f, 0x05, 0x59, 0x5a, 0x5e, 0x5f, 0x58, 0xe9, 0x42, */
/* 	0x42, 0x42, 0x42 */
/* }; */

uint8_t parasite[204] = {
	0x50, 0x57, 0x56, 0x52, 0x51, 0xeb, 0x74, 0x55, 0x48, 0x89,
	0xe5, 0xb8, 0x05, 0x15, 0x00, 0x00, 0x48, 0x85, 0xf6, 0x74,
	0x1f, 0x48, 0x31, 0xc9, 0x48, 0x89, 0xc2, 0x48, 0xc1, 0xe0,
	0x05, 0x48, 0x01, 0xd0, 0x48, 0x0f, 0xb6, 0x17, 0x48, 0x01,
	0xd0, 0x48, 0xff, 0xc1, 0x48, 0xff, 0xc7, 0x48, 0x39, 0xf1,
	0x7c, 0xe4, 0xc9, 0xc3, 0x55, 0x48, 0x89, 0xe5, 0x48, 0x85,
	0xf6, 0x74, 0x3a, 0x57, 0x56, 0xe8, 0x18, 0x00, 0x00, 0x00,
	0x64, 0x65, 0x63, 0x72, 0x79, 0x70, 0x74, 0x69, 0x6f, 0x6e,
	0x20, 0x6b, 0x65, 0x79, 0x3a, 0x20, 0x25, 0x23, 0x2e, 0x31,
	0x36, 0x6c, 0x78, 0x0a, 0x5f, 0x48, 0x89, 0xd6, 0xe8, 0x99,
	0xfe, 0xff, 0xff, 0x5e, 0x5f, 0x48, 0x31, 0xc9, 0x30, 0x17,
	0x48, 0xff, 0xc1, 0x48, 0xff, 0xc7, 0x48, 0x39, 0xf1, 0x7c,
	0xf3, 0xc9, 0xc3, 0x48, 0x8d, 0x3d, 0x7e, 0xff, 0xff, 0xff,
	0xbe, 0x42, 0x42, 0x42, 0x42, 0xe8, 0x7b, 0xff, 0xff, 0xff,
	0x48, 0x8d, 0x3d, 0x6d, 0xff, 0xff, 0xff, 0xbe, 0x42, 0x42,
	0x42, 0x42, 0xe8, 0x99, 0xff, 0xff, 0xff, 0xe8, 0x0e, 0x00,
	0x00, 0x00, 0x2e, 0x2e, 0x2e, 0x2e, 0x57, 0x4f, 0x4f, 0x44,
	0x59, 0x2e, 0x2e, 0x2e, 0x2e, 0x0a, 0xb8, 0x01, 0x00, 0x00,
	0x00, 0xbf, 0x01, 0x00, 0x00, 0x00, 0x5e, 0xba, 0x0e, 0x00,
	0x00, 0x00, 0x0f, 0x05, 0x59, 0x5a, 0x5e, 0x5f, 0x58, 0xe9,
	0x42, 0x42, 0x42, 0x42
};

static int
check_ehdr(Elf64_Ehdr *ehdr, size_t length)
{
	if (sizeof(Elf64_Ehdr) > length)
		return (error(ERR_CORRUPT, "ELF header"));
	if (ehdr->e_type != ET_EXEC && ehdr->e_type != ET_DYN)
		return (error(ERR_EHDR, "executable type (EXEC or DYN)"));
	if (ehdr->e_machine != EM_X86_64)
		return (error(ERR_EHDR, "machine architecture (X86_64)"));
	if (ehdr->e_entry == 0)
		return (error(ERR_EHDR, "entry point"));
	if (ehdr->e_phoff == 0 || ehdr->e_phnum == 0)
		return (error(ERR_EHDR, "program header table"));
	if (ehdr->e_shoff == 0 || ehdr->e_shnum == 0)
		return (error(ERR_EHDR, "section header table"));
	return (0);
}

static int
patch(Elf64_Ehdr *ehdr, Elf64_Phdr *phdr, Elf64_Shdr *shdr)
{
	*(uint32_t *)(parasite + PARA_LEN) = (uint32_t)(sizeof(parasite));
	*(uint32_t *)(parasite + TEXT_OFF) = (uint32_t)(shdr->sh_offset
		- (phdr->p_vaddr + phdr->p_memsz + TEXT_OFF + 4));
	*(uint32_t *)(parasite + TEXT_LEN) = (uint32_t)(shdr->sh_size);
	*(uint32_t *)(parasite + JUMP_OLD) = (uint32_t)(ehdr->e_entry
		- (phdr->p_vaddr + phdr->p_memsz + JUMP_OLD + 4));
	return (0);
}

static int
inject(Elf64_Ehdr *ehdr, Elf64_Phdr *phdr, struct elf_info *bin)
{
	if (((phdr->p_filesz + phdr->p_align - 1) & ~(phdr->p_align - 1))
		- phdr->p_filesz < sizeof(parasite))
		return (error(ERR_SPACE, bin->name));
	ft_memcpy((char *)bin->addr + phdr->p_offset + phdr->p_filesz,
		parasite, sizeof(parasite));
	ehdr->e_entry = phdr->p_vaddr + phdr->p_memsz;
	phdr->p_filesz += sizeof(parasite);
	phdr->p_memsz += sizeof(parasite);
	phdr->p_flags |= PF_W;
	return (0);
}

int
packer64(struct elf_info *bin)
{
	Elf64_Ehdr *ehdr;
	Elf64_Phdr *phdr;
	Elf64_Shdr *shdr;
	uint64_t key;

	ehdr = (Elf64_Ehdr *)bin->addr;
	if (check_ehdr(ehdr, bin->length))
		return (1);
	if (get_exec_phdr64(ehdr, &phdr, bin))
		return (1);
	if (get_text_shdr64(ehdr, &shdr, bin))
		return (1);
	patch(ehdr, phdr, shdr);
	key = hash(parasite, sizeof(parasite));
	printf("encryption key: %#.16lx\n", key);
	encrypt(bin->addr + shdr->sh_offset, shdr->sh_size, key);
	if (inject(ehdr, phdr, bin))
		return (1);
	return (0);
}
